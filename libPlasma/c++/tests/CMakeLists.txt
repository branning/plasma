# /* (c)  oblong industries */

project(Plasma++Tests)

add_library(SlawTypesTest STATIC SlawTypesTest.cpp Callbacks.cpp)

#----------- main list of tests, needs pool server ---------

set(
  Plasma++Tests_TESTS

  HoseNthTest
  HoseTest
  HoseTimedTest
  # hose-timed-test.rb -- just a wrapper around HoseTimedTest
  PoolTest
  ProteinTest
)

# Test fixture X is defined by files in bld/cmake/fixtures/X, see bld/cmake/yotest.in
# The 'tcps' test fixture's certificates in bld/cmake/fixtures/tcps/
# were generated by ob-plasma-cert.sh, and will need to be regenerated
# again when they expire.  FIXME: run that script each time?
set(Plasma++Tests_FIXTURES
  local
  tcp
  tcpo
  tcps
)
set(Plasma++Tests_LINK_LIBS SlawTypesTest Plasma++ ${Plasma++_LINK_LIBS})
generate_tests("${Plasma++Tests_TESTS}" "${Plasma++Tests_LINK_LIBS}" "${Plasma++Tests_FIXTURES}")

#----------- slaw-only tests, don't need pool server ---------

set(
  Plasma++Tests_TESTS_SLAWONLY

  ArraySlawTest
  RefCountedTest
  SlawConsTest
  SlawIteratorTest
  SlawListTest
  SlawMapDuplicateTest
  SlawMapTest
  SlawRefTest
  SlawScopeTest
  SlawSerializationTest
  SlawTest
  slaw-traits-test
  SlawVectorArrayTest
)
generate_tests("${Plasma++Tests_TESTS_SLAWONLY}" "${Plasma++Tests_LINK_LIBS}")

if (APPLE)
  # Kludge; Objective-C++ tests don't quite fit into the above scheme
  foreach(test ObjcPlusPlus)
    set_source_files_properties(${test}.cpp PROPERTIES COMPILE_FLAGS "-x objective-c++")
    add_executable(${test} ${test}.cpp)
    target_link_libraries(${test} gtest gtest_main SlawTypesTest ${Plasma++_LINK_LIBS} Plasma++)
    target_link_libraries(${test} "-framework CoreFoundation -framework Cocoa")
    add_wrapped_test(${test} ${test} "local")
  endforeach()
endif()
